## 性能测试

### 测试案例

**测试结果**

测试案例只测试了单聊, 支持约 3000/s 消息吞吐量, 这只是下限, 由于测试环境限制, 性能上限并未测出.

![performance.png](https://github.com/Glide-IM/Glide-IM/raw/master/_art/msg_io.png)

**测试过程**

服务端配置
```
Windows 10
AMD R5 3600 6核12线程 
16GB 内存
100Mbps 网卡
```

负载情况:
```
2000 连接
5-20条消息/秒/连接
30k消息/tps
送达率 100%
```

A 机器运行服务端,  B模拟客户端连接登录发消息的过程, 并运行数据库

同时模拟 2000 客户端, 每间隔 60ms-200ms 发送一条消息, 每个客户端发送 600 条消息, 共计 1200_000 条消息.

网卡负载平均 90% (100Mbps), 每秒约 30_000 条消息吞吐量, 每秒上下行各 15k 条, 送达率 100%, 所有消息延时<=20ms

**测试环境限制**

且由于 IM 核心性能参数是消息吞吐量, 而不是连接数(连接数仅仅与内存有关系, 内存够大, 不发消息的连接几千万都没问题), 我只测试了消息吞吐量.

由于测试只有两台电脑, 存在端口数限制(部署到服务器, 用户连接不存在这个限制), 为了提高 MySQL 连接池的大小提高并发, 必须尽量用更少的连接数和每个连接更密集的发送消息来进行测试

百兆网卡上限速率只有 12.5MB/s, 一条消息包含 20 个汉字则至少需要 40B, 再加上报头其他占用, 假设 100B, 则实际百兆网卡最大的消息并发是 12.5 x 1024 x 1024 / 100 = 131072

### 测试代码

单机性能测试

1. 启动服务器

```shell
go test -v -run=TestServerPerf
```

2. 开始用户模拟

```shell
go test -v -run=TestRunClient
```