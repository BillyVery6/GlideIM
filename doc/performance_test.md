## 性能测试

### 测试案例

**测试结果 1**

这个测试案例只测试了单聊, 支持约 30000/s 消息吞吐量, 网卡负载达到极限.

![performance.png](https://github.com/Glide-IM/Glide-IM/raw/master/_art/msg_io.png)

**测试结果 2**

这个案例同比上个测试, 我去除了 mysql 占用的连接数和网卡吞吐量限制, 所有消息插入均用 20 ms的延时代替, 实际后期存消息做优化能达到这个速度

![performance.png](https://github.com/Glide-IM/Glide-IM/raw/master/_art/msg_io_no_db.png)

**测试环境**

服务端配置

```
Windows 10
AMD R5 3600 6核12线程 
16GB 内存
100Mbps 网卡
```

**案例 1 测试过程**

A 机器运行服务端, B模拟客户端连接登录发消息的过程, 并运行数据库

同时模拟 2000 客户端, 每间隔 60ms-200ms 发送一条消息, 每个客户端发送 600 条消息, 共计 1200_000 条消息.

网卡负载平均 90% (100Mbps), 每秒约 30_000 条消息吞吐量, 每秒上下行各 15k 条, 送达率 100%, 所有消息延时<=20ms, 参考结果1图.

测试情况:

```
网络 100%
2000 连接
5-20条消息/秒/连接
30k消息/tps
送达率 100%
```

**案例 2 测试过程**

这个案例只为了测试程序在高并发情况下的运行情况, 参考价值也仅限于程序本身的短板和代码逻辑极限, 在实际情况中我们无法忽略网络速率等因素的影响.

由于需要去除网卡速率限制, 服务和模拟客户端都在同一台设备上运行则不受网络因素影响, 模拟10000个链接, 每个连接 50ms-100ms 发送一条消息, 总共发送 800 条.

此案例消息吞吐量极限为 28w, 此时已达到 cpu 性能极限, 占用率约98%, 客户端模拟 cpu 占用率高于服务端, 但无关紧要.

测试案例 pprof CPU使用情况分析数据: [cpu.out](https://github.com/Glide-IM/Glide-IM/raw/master/_art/cpu_pprof_msg_io_no_db.out)

测试情况:

```
CPU 98 %
内存约 3 GB
10000 连接峰值, 每 10ms 开始一个连接
10-20条消息/秒/连接, 累计发送800条
280k消息/tps 峰值
送达率 100%
```

**测试环境限制**

由于测试只有两台电脑, 存在端口数限制(部署到服务器, 用户连接不存在这个限制), 为了提高 MySQL 连接池的大小提高并发, 必须尽量用更少的连接数和每个连接更密集的发送消息来进行测试

百兆网卡上限速率只有 12.5MB/s, 一条消息包含 20 个汉字则至少需要 40B, 再加上报头其他占用, 假设 100B, 则实际百兆网卡最大的消息并发是 12.5 x 1024 x 1024 / 100 = 13w 条, 而去除
ACK, 再上下行消息数量对半, 实际可能就 6w/s 消息就是 GlideIM 在 100Mbps 环境下的理论极限.

### 测试代码

单机性能测试

测试代码路径: [/cmd/performance_test/](https://github.com/Glide-IM/Glide-IM/tree/master/cmd/performance_test)

1. 启动服务器

```shell
go test -v -run=TestServerPerf
```

2. 开始用户模拟

```shell
go test -v -run=TestRunClient
```

### 性能参考指标说明

**连接数**

很多 IM 项目喜欢用类似于 "百万连接" 之类的字眼, 很多人可能是受常规 HTTP 服务 "百万并发" 的影响, 认为百万连接与百万并发具有一致的性能参考价值, 开发者为了吸引眼球使用百万连接的字眼, 也确实支持百万链接.

事实上, TCP(或WS) 连接数的限制并不在于程序本身, 系统最大可打开 文件描述符 和 内存 限制了最大连接数, 一个 TCP 连接大约需要占用 4-10KB 内存, 一台 16GB 的服务器理论上最大支持约 16 * 1024 *
1024 / 5 ≈ 335w 连接.

活跃用户数则比单纯的连接数更有参考价值, 例如支持 100w 活跃连接, 每个活跃连接10s发送一条消息.

**消息吞吐量**

相比连接数, 消息吞吐量更具有参考价值, 消息吞吐量需要结合网络速率做参考. 消息吞吐量受限点主要有一下几个:

1. 消息送达保障机制的性能(即保障送达又不冗余)
2. 消息数据传输协议的性能(单条消息尽可能减小体积)
3. 非用户消息的数据包数量控制(例如心跳包, 内容同步包等)
4. 网络速率和质量(外部因素)
5. 程序本身消息下发设计缺陷

**其他指标**

考量一款 IM 的性能的意义大部分可能只在于揭示它自身的性能短板, 横向对比其他项目在大部分情况都无法得出正确的对比结果, 单项指标也不能完全衡量整个项目的优劣, 我们应该结合其业务逻辑, 设计思想, 学习其优点才能有所收获.

1. 消息送达率
2. 消息延迟和消息顺序的准确性
3. 链接保活和去死链(心跳)

### 性能指标估算

1. 连接数

假设设内存为 M GB

```text
理论连接数  = M * 1024m * 1024k / (4k/tcp)

保守估算连接数 = M * 1024m * 1024k / (10k/tcp)
```

2. 消息吞吐量估算

设网卡速率为 S Mbps, 平均每条消息为 K 字节(写入 TCP 连接时的总大小).

```text
消息吞吐量 = S / 8 * 1024k * 1024b / K
```

3. 活跃用户数估算

设吞吐量 T, 设平均每个用户每 N 秒发送一条消息.

- 在确认送达机制下 (每条消息的发送, 假设收发双方读在线, 服务端客户都需ACK, 共需要 5 条消息上下行)

```text
活跃用户数 = T / 5 * N
```

- 仅确认送达服务端

```text
活跃用户数 = T / 3 * N
```




