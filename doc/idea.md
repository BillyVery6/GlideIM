# 分布式架构的设计

## 01. 服务的拆分

## 02. 服务的拆分

1. Gateway
2. Group
3. Auth
4. ApiHTTP
5. Router

## 03. 服务的通信

1. RPC

2. MQ

## 04. 消息路由

由于IM网关和群服务属于有状态服务, 消息分发去就需要路由到消息对应的服务

消息中添加发送方和接收方网关标识 

需要客户端缓存并在合适的时候更新缓存

1. 方案一: 用户上下线实时通知好友, 更新所在 node_id
2. 方案二: 用户上下线同步好友列表和所在 node_id 等消息
3. 方案三: 发送方发送消息所在网关附带上自己的 node_id, 接收方网关做缓存
4. 路由消息时若 node_id 不正确则服务端查询接收方所在网关, 并通知更新正确的 node_id

## 05. C.A.P 之间的权衡

一个分布式系统一致性,可用性,容错性不能同时都满足, 一般情况舍弃高一致性, 只求最终一致性.